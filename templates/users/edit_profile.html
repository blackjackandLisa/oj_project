{% extends 'base.html' %}
{% load static %}

{% block title %}修改个人信息 - OJ系统{% endblock %}

{% block extra_css %}
<style>
    .profile-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .profile-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .avatar-section {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .avatar-preview {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #007bff;
        margin-bottom: 15px;
    }
    
    .avatar-upload {
        display: none;
    }
    
    .avatar-upload-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .avatar-upload-btn:hover {
        background: #0056b3;
    }
    
    .form-section {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .section-title {
        color: #333;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
    }
    
    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        transition: border-color 0.3s;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }
    
    .form-control.is-invalid {
        border-color: #dc3545;
    }
    
    .invalid-feedback {
        display: block;
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
    }
    
    .form-text {
        font-size: 12px;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .btn-group {
        text-align: center;
        margin-top: 30px;
    }
    
    .btn {
        padding: 10px 30px;
        border: none;
        border-radius: 5px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        margin: 0 10px;
        transition: all 0.3s;
    }
    
    .btn-primary {
        background: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: #0056b3;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #545b62;
    }
    
    .alert {
        padding: 12px 16px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    
    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .alert-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid #007bff;
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .password-section {
        background: #f8f9fa;
        border-left: 4px solid #007bff;
    }
    
    .preference-section {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-header">
        <h2><i class="fas fa-user-edit"></i> 修改个人信息</h2>
        <p class="text-muted">更新您的个人资料和偏好设置</p>
    </div>
    
    <!-- 成功/错误提示 -->
    <div id="alert-container"></div>
    
    <!-- 头像上传 -->
    <div class="form-section">
        <div class="section-title">
            <i class="fas fa-camera"></i> 头像设置
        </div>
        <div class="avatar-section">
            <img id="avatar-preview" 
                 src="{% if profile.avatar %}{{ profile.avatar.url }}{% else %}{% static 'images/default-avatar.svg' %}{% endif %}" 
                 alt="头像预览" 
                 class="avatar-preview">
            <br>
            <input type="file" id="avatar-upload" class="avatar-upload" accept="image/*">
            <button type="button" class="avatar-upload-btn" onclick="document.getElementById('avatar-upload').click()">
                <i class="fas fa-upload"></i> 更换头像
            </button>
            <p class="form-text">支持 JPG、PNG、GIF 格式，文件大小不超过2MB</p>
        </div>
    </div>
    
    <!-- 基本信息 -->
    <div class="form-section">
        <div class="section-title">
            <i class="fas fa-user"></i> 基本信息
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label" for="username">用户名</label>
                    <input type="text" 
                           class="form-control" 
                           id="username" 
                           value="{{ user.username }}"
                           placeholder="请输入用户名">
                    <div class="invalid-feedback"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label" for="email">邮箱</label>
                    <input type="email" 
                           class="form-control" 
                           id="email" 
                           value="{{ user.email }}"
                           placeholder="请输入邮箱地址">
                    <div class="invalid-feedback"></div>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="bio">个人简介</label>
            <textarea class="form-control" 
                      id="bio" 
                      rows="3" 
                      placeholder="介绍一下自己吧...">{{ profile.bio }}</textarea>
            <div class="form-text">最多500个字符</div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label" for="school">学校</label>
                    <input type="text" 
                           class="form-control" 
                           id="school" 
                           value="{{ profile.school }}"
                           placeholder="请输入学校名称">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label" for="major">专业</label>
                    <input type="text" 
                           class="form-control" 
                           id="major" 
                           value="{{ profile.major }}"
                           placeholder="请输入专业名称">
                </div>
            </div>
        </div>
    </div>
    
    <!-- 联系方式 -->
    <div class="form-section">
        <div class="section-title">
            <i class="fas fa-phone"></i> 联系方式
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label" for="phone">手机号</label>
                    <input type="tel" 
                           class="form-control" 
                           id="phone" 
                           value="{{ profile.phone }}"
                           placeholder="请输入手机号">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label" for="wechat">微信号</label>
                    <input type="text" 
                           class="form-control" 
                           id="wechat" 
                           value="{{ profile.wechat }}"
                           placeholder="请输入微信号">
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label" for="github">GitHub</label>
                    <input type="url" 
                           class="form-control" 
                           id="github" 
                           value="{{ profile.github }}"
                           placeholder="https://github.com/yourname">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label" for="blog">个人博客</label>
                    <input type="url" 
                           class="form-control" 
                           id="blog" 
                           value="{{ profile.blog }}"
                           placeholder="https://yourblog.com">
                </div>
            </div>
        </div>
    </div>
    
    <!-- 密码修改 -->
    <div class="form-section password-section">
        <div class="section-title">
            <i class="fas fa-lock"></i> 密码修改
        </div>
        
        <div class="form-group">
            <label class="form-label" for="old_password">原密码</label>
            <input type="password" 
                   class="form-control" 
                   id="old_password" 
                   placeholder="请输入原密码">
            <div class="invalid-feedback"></div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label" for="new_password">新密码</label>
                    <input type="password" 
                           class="form-control" 
                           id="new_password" 
                           placeholder="请输入新密码">
                    <div class="invalid-feedback"></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label" for="confirm_password">确认新密码</label>
                    <input type="password" 
                           class="form-control" 
                           id="confirm_password" 
                           placeholder="请再次输入新密码">
                    <div class="invalid-feedback"></div>
                </div>
            </div>
        </div>
        <div class="form-text">密码至少6位，留空表示不修改密码</div>
    </div>
    
    <!-- 偏好设置 -->
    <div class="form-section preference-section">
        <div class="section-title">
            <i class="fas fa-cog"></i> 偏好设置
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label" for="language_preference">编程语言偏好</label>
                    <select class="form-control" id="language_preference">
                        <option value="Both" {% if profile.language_preference == 'Both' %}selected{% endif %}>两者都喜欢</option>
                        <option value="C++" {% if profile.language_preference == 'C++' %}selected{% endif %}>C++</option>
                        <option value="Python" {% if profile.language_preference == 'Python' %}selected{% endif %}>Python</option>
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label" for="theme_preference">主题偏好</label>
                    <select class="form-control" id="theme_preference">
                        <option value="auto" {% if profile.theme_preference == 'auto' %}selected{% endif %}>跟随系统</option>
                        <option value="light" {% if profile.theme_preference == 'light' %}selected{% endif %}>浅色主题</option>
                        <option value="dark" {% if profile.theme_preference == 'dark' %}selected{% endif %}>深色主题</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 操作按钮 -->
    <div class="btn-group">
        <button type="button" class="btn btn-primary" onclick="saveProfile()">
            <i class="fas fa-save"></i> 保存修改
        </button>
        <button type="button" class="btn btn-secondary" onclick="window.location.href='{% url 'users:profile' %}'">
            <i class="fas fa-times"></i> 取消
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 头像上传处理
document.getElementById('avatar-upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // 检查文件类型
        if (!file.type.startsWith('image/')) {
            showAlert('请选择图片文件', 'danger');
            return;
        }
        
        // 检查文件大小
        if (file.size > 2 * 1024 * 1024) {
            showAlert('图片文件大小不能超过2MB', 'danger');
            return;
        }
        
        // 预览图片
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('avatar-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
        
        // 上传头像
        uploadAvatar(file);
    }
});

// 上传头像
function uploadAvatar(file) {
    const formData = new FormData();
    formData.append('avatar', file);
    
    fetch('{% url "users:upload_avatar_api" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
        } else {
            showAlert(data.errors.avatar || '头像上传失败', 'danger');
        }
    })
    .catch(error => {
        showAlert('头像上传失败：' + error.message, 'danger');
    });
}

// 保存个人信息
function saveProfile() {
    // 清除之前的错误状态
    clearErrors();
    
    // 收集表单数据
    const data = {
        username: document.getElementById('username').value.trim(),
        email: document.getElementById('email').value.trim(),
        bio: document.getElementById('bio').value.trim(),
        school: document.getElementById('school').value.trim(),
        major: document.getElementById('major').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        wechat: document.getElementById('wechat').value.trim(),
        github: document.getElementById('github').value.trim(),
        blog: document.getElementById('blog').value.trim(),
        old_password: document.getElementById('old_password').value,
        new_password: document.getElementById('new_password').value,
        confirm_password: document.getElementById('confirm_password').value,
        language_preference: document.getElementById('language_preference').value,
        theme_preference: document.getElementById('theme_preference').value
    };
    
    // 显示加载状态
    const saveBtn = document.querySelector('.btn-primary');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
    saveBtn.disabled = true;
    
    // 发送请求
    fetch('{% url "users:update_profile_api" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            // 清空密码字段
            document.getElementById('old_password').value = '';
            document.getElementById('new_password').value = '';
            document.getElementById('confirm_password').value = '';
        } else {
            // 显示错误信息
            showErrors(data.errors);
        }
    })
    .catch(error => {
        showAlert('保存失败：' + error.message, 'danger');
    })
    .finally(() => {
        // 恢复按钮状态
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    });
}

// 显示错误信息
function showErrors(errors) {
    for (const field in errors) {
        const input = document.getElementById(field);
        const feedback = input.nextElementSibling;
        
        if (input && feedback) {
            input.classList.add('is-invalid');
            feedback.textContent = errors[field];
        } else {
            // 通用错误信息
            showAlert(errors[field], 'danger');
        }
    }
}

// 清除错误状态
function clearErrors() {
    const inputs = document.querySelectorAll('.form-control');
    inputs.forEach(input => {
        input.classList.remove('is-invalid');
        const feedback = input.nextElementSibling;
        if (feedback && feedback.classList.contains('invalid-feedback')) {
            feedback.textContent = '';
        }
    });
}

// 显示提示信息
function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
        ${message}
        <button type="button" class="close" onclick="this.parentElement.remove()">
            <span>&times;</span>
        </button>
    `;
    
    alertContainer.innerHTML = '';
    alertContainer.appendChild(alertDiv);
    
    // 3秒后自动消失
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 3000);
}

// 获取CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
